<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content="Pearyman'S BLOG">
<meta name="author" content="Pearyman">
<meta name="description" content="html5,css3,app" />
<meta name="keywords" content="Pearyman,BLOG" />
<link rel="Shortcut Icon" href="http://7xw3j4.com1.z0.glb.clouddn.com/logo_cai.png" type="image/ico">
<title>jquery的on方法如何导致事件累加</title>
<style type="text/css">
    #content{margin:0 auto 50px; width: 66%;}
    #disqus_thread{margin:0 auto; width: 66%;}
  .ds-powered-by,.navbar ,.ds-sync{display: none;}
</style>
<xmp theme="united" style="display:none;">
#jquery的on方法如何导致事件累加

###被冤枉的ajax
项目中第一次正式写交互，没写之前底气不足不敢写，浓黑浓黑的小眉毛都愁的快拧巴到了一起，同事见状鼓励说：试着写一写，慢慢来。听后稍有安慰，然而内心还是酱紫的![alt title](http://7xw3j4.com1.z0.glb.clouddn.com/blog_05.gif)


这个页面的交互相当于登陆页的交互，哝，就长这样的


![alt title](http://7xw3j4.com1.z0.glb.clouddn.com/blog_05_01.png)

我在第一次请求AJAX成功后又嵌套了一个AJAX，也就是说‘确认’的这个AJAX的交互要在第一个验证码发送请求成功的条件下才能走到它，然而看似没有什么问题的逻辑在测试时发现了异常，哝，代码就在下面

    $(".j_add_caution_btn").on("click", function() {
    Dialog.alert({
        overlay: 1,
        title: '新增提醒',
        dialogBody: '<div class="dialog-bd"><div class="number-input"><p>请输入手机号或邮箱</p><input type="text"><a href="javascript:;" class="code">获取验证码</a><p class="rdp-dialog-error-info email-phone-verify"></p></div><div class="code-input"><p>请输入验证码</p><input type="text" class="verifycode"></div><p class="rdp-dialog-error-info wrong-verify"></p></div><p class="notice-error-message"></p>',
        onload: function(dailog, node) {
            // 获取验证码
            $(".code").on("click", function() {
                if ($(".code").attr("disabled")) {
                    return false;
                } else {
                    var input_number = $(".number-input input").val();
                    if (input_number != '' && Base.regexp.isMobile(input_number) || input_number != '' && Base.regexp.isEmail(input_number)) {
                        $.ajax({
                            url: '/profile/alert/captcha/ajax',
                            type: 'post',
                            data: {
                                account: input_number
                            },
                            success: function(res) {
                                var res = $.parseJSON(res);
                                if (res.success) {
                                    $('.email-phone-verify').hide();
                                    A.sendCode(59);
                                } else {
                                    $('.email-phone-verify').text(res.msg);
                                }
                                // 点击确认
                              $(".pub-dialog-confirm").on("click", function() {
                                  var input_number = $(".number-input input").val();
                                  var verifycode = $(".verifycode").val();
                                  if (input_number != '' && verifycode != '') {
                                      $.ajax({
                                          url: '/profile/alert/add/ajax',
                                          type: 'post',
                                          data: {
                                              account: input_number,
                                              code: verifycode,
                                          },
                                          success: function(res) {
                                              var res = $.parseJSON(res);
                                              if (res.success) {
                                                  window.location.reload();
                                              } else {
                                                  $('.notice-error-message').text(res.msg);
                                              }
                                          },
                                          error: function() {

                                          }
                                      })
                                  } else {
                                      $('.notice-error-message').text('请输入手机号或邮箱号');
                                  }

                              })
                            },
                            error: function() {

                            }
                        })
                    } else {
                        $('.email-phone-verify').text('请输入手机号或邮箱是否正确！');
                    }

                }
            });
        },
        draggable: 1
    });
    });  


效果已经不能再现了，因为是项目中的部分代码，所以这个bug很显然已经被修复了，由我口述好了，各位想象一下


1. 在第一个输入框有正确的值的情况下，点击获取验证码，触发第一个ajax，然后收到相应的验证码，填入第二个输入框
2. 在第二个输入框的验证码错误的情况下，点击确认，触发第二个ajax，因为验证码是错的，所以后台返回的信息是‘验证码错误’，好，到目前为止都是没什么问题的
3. 再次点击获取验证码时，依然在第二个输入框填入错误的验证码，然后打开谷歌浏览器如下图查看这次点击‘确认’时，意外的发现点击了一次按钮，却发送了两次ajax
4. 继续重复1.2.会发现持续累加

![alt title](http://7xw3j4.com1.z0.glb.clouddn.com/blog_05_02.png)

**话说怎么解决的**：我愁啊一开始，你说这交互坑次坑次好不容易写好了，突然出现这么要命的bug真是找原因找的直薅头发，以我的能力实在没法找出原因了。向同事发出了求救的目光加哀嚎，同事估计级也是同情我这个小菜鸟，过来三下五除二，完事了。。。


我就看啊，他不过是把我嵌套在第一个AJAX的成功后里面的AJAX提出来而已，我就想啊，原来是ajax的事啊，问题又来了它怎么就不能嵌套了呢
###水落石出显原形（on）
下班后还一直对此念念不忘啊，回来各种查资料，并没有说ajax里面不能嵌套ajax，倒是在不小心查jquery的on方法时意外发现了端倪。


[点击这里看demo](http://jsbin.com/yoqayexequ/edit?html,js,console,output)

**直接和委托的事件**

大多数浏览器事件冒泡, 或者 传播，都是由内到外的，从在文档最深处的元素( 事件目标 event target)开始， 一路传递到body和document元素。（愚人码头注：事件冒泡简单的说就是，在冒泡路径上所有绑定了相同事件类型的元素上都会触发这些类型的事件。）在Internet Explorer 8和更低，一些事件，如change 和 submit本身不冒泡，但 jQuery 为了跨浏览器一致性， jQuery 在这些事件上模拟了冒泡行为。


如果省略selector或者是null，那么事件处理程序被称为直接事件 或者 直接绑定事件 。每次选中的元素触发事件时，就会执行处理程序，不管它直接绑定在元素上，还是从后代（内部）元素冒泡到该元素的


当提供selector参数时，事件处理程序是指为委派 事件（愚人码头注：通常也有很多人叫它代理事件）。事件不会在直接绑定的元素上触发，但当selector参数选择器匹配到后代（内部元素）的时候，事件处理函数才会被触发。jQuery 会从 event target 开始向上层元素(例如，由最内层元素到最外层元素)开始冒泡，并且在传播路径上所有绑定了相同事件的元素若满足匹配的选择器，那么这些元素上的事件也会被触发。


明白了吧，juqery on方法有事件委托的功效，你给委托后它可不就每次点击就累加，解决办法要么就是像我同事那样提出来写，要么就解除绑定。当然如果不是必要的话还是我同事那样写比较规范，向规范致敬！
</xmp>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//httpsfedlovergithubio.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
<script src="https://fedlover.github.io/js/strapdown.js"></script>
</html>

